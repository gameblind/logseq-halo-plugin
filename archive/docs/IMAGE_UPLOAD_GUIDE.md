# 图片上传功能使用指南

## 功能概述

本插件现在支持自动处理 Logseq 中的图片，将其上传到 Halo 服务器并替换为正确的链接。

## 支持的图片格式

- PNG (.png)
- JPEG (.jpg, .jpeg)
- GIF (.gif)
- WebP (.webp)
- SVG (.svg)

## 图片路径处理

插件会自动识别和处理以下格式的图片链接：

```markdown
![图片描述](../assets/image_1754625746051_0.png)
```

## 工作流程

1. **检测图片**：插件扫描 Markdown 内容中的图片链接
2. **读取文件**：从 Logseq 的 assets 目录读取图片文件
3. **上传到 Halo**：将图片上传到 Halo 服务器的附件系统
4. **替换链接**：将原始的相对路径替换为 Halo 服务器的图片 URL
5. **发布文章**：发布包含正确图片链接的文章

## 测试步骤

### 1. 准备测试图片

确保你的 Logseq 项目中有图片文件，例如：
- `assets/image_1754625746051_0.png`

### 2. 创建测试文章

在 Logseq 中创建一篇包含图片的文章：

```markdown
# 测试文章

这是一张测试图片：

![测试图片](../assets/image_1754625746051_0.png)

图片应该正常显示。
```

### 3. 使用插件发布

1. 在 Logseq 中打开包含图片的页面
2. 使用 Halo 插件的发布功能
3. 插件会自动处理图片上传

### 4. 验证结果

发布成功后：
1. 在 Halo 后台查看文章
2. 确认图片正常显示
3. 检查图片链接是否指向 Halo 服务器

## 故障排除

### 图片无法读取

如果遇到图片读取失败，插件会尝试以下路径：
1. `assets/图片文件名`
2. `../assets/图片文件名`
3. `../../assets/图片文件名`
4. 原始路径
5. 仅文件名

### 上传失败

可能的原因：
1. **网络连接问题**：检查与 Halo 服务器的连接
2. **权限问题**：确保 API Token 有上传附件的权限
3. **文件格式不支持**：确认图片格式在支持列表中
4. **文件大小限制**：检查 Halo 服务器的文件大小限制

### 调试信息

插件会在控制台输出详细的日志信息：
- 图片检测结果
- 文件读取状态
- 上传进度
- 错误信息

打开浏览器开发者工具查看控制台日志以获取更多信息。

## 技术实现

### 图片检测

使用正则表达式匹配 Markdown 中的图片语法：
```javascript
/!\[([^\]]*)\]\(([^)]+)\)/g
```

### 文件读取

使用 Fetch API 尝试多个可能的路径来读取图片文件。

### 上传机制

通过 Halo 的附件 API 上传图片：
```
POST /apis/api.console.halo.run/v1alpha1/attachments/upload
```

### 链接替换

将原始的相对路径替换为 Halo 返回的图片 URL。

## 注意事项

1. **文件路径**：确保图片文件存在于 Logseq 的 assets 目录中
2. **网络环境**：需要稳定的网络连接到 Halo 服务器
3. **权限配置**：API Token 需要有附件上传权限
4. **文件大小**：注意 Halo 服务器的文件大小限制
5. **格式支持**：使用支持的图片格式

## 更新日志

### v1.0.0
- 实现基础图片上传功能
- 支持多种图片格式
- 智能路径解析
- 错误处理和日志记录