# 图片上传功能故障排除指南

## 问题现象

用户反馈：
- 上传的文章还是原来的本地图片路径
- Halo 附件中没有对应的图片
- 图片上传功能似乎没有生效

## 可能的原因和解决方案

### 1. 图片路径格式问题

**检查点：** 确认 Logseq 中的图片格式是否正确

**正确格式：**
```markdown
![image.png](../assets/image_1754625746051_0.png)
```

**不支持的格式：**
```markdown
![image.png](./assets/image.png)  # 不以 ../assets/ 开头
![image.png](https://example.com/image.png)  # 外部链接（会被跳过）
```

**解决方案：**
- 确保图片路径以 `../assets/` 开头
- 在 Logseq 中重新插入图片（拖拽或粘贴）

### 2. 图片文件不存在

**检查点：** 图片文件是否真实存在于 assets 目录中

**调试步骤：**
1. 打开 Logseq 的图谱目录
2. 检查 `assets` 文件夹
3. 确认图片文件存在且可访问

**解决方案：**
- 重新在 Logseq 中插入图片
- 确保图片文件没有被删除或移动

### 3. 网络权限问题

**检查点：** 浏览器是否允许插件访问本地文件

**可能的错误：**
- CORS 错误
- 文件访问权限被拒绝
- 网络请求被阻止

**解决方案：**
- 确保 Logseq 在本地环境中运行
- 检查浏览器控制台是否有错误信息
- 尝试重启 Logseq 应用

### 4. Halo API 配置问题

**检查点：** Halo 站点配置和 API 权限

**必要条件：**
- Halo 站点 URL 正确
- API Token 有效且有上传权限
- 网络连接正常

**测试方法：**
1. 使用插件的"测试连接"功能
2. 检查 Halo 后台的附件上传设置
3. 确认 API Token 权限包含附件管理

### 5. 插件日志调试

**启用详细日志：**
1. 打开插件设置
2. 将日志级别设置为 "DEBUG"
3. 重新尝试发布文章
4. 查看插件日志

**关键日志信息：**
```
开始处理图片，原始内容: ...
正则表达式匹配结果: ...
找到 X 张图片需要上传
开始上传图片: ../assets/xxx.png
尝试路径: ./assets/xxx.png
路径响应状态: 200, Content-Type: image/png
成功读取图片: ./assets/xxx.png, 大小: XXX 字节
图片上传成功: ../assets/xxx.png -> https://halo.example.com/...
```

### 6. 手动测试步骤

**创建测试文章：**
1. 在 Logseq 中创建新页面
2. 添加以下内容：
   ```markdown
   # 图片上传测试
   
   ![test-image](../assets/test-image.svg)
   
   这是一张测试图片。
   ```
3. 确保 `assets/test-image.svg` 文件存在
4. 使用插件发布到 Halo
5. 检查发布结果

**预期结果：**
- 文章中的图片链接被替换为 Halo 的 URL
- Halo 后台附件中出现上传的图片
- 发布的文章中图片正常显示

### 7. 常见错误和解决方案

**错误："没有找到需要上传的图片"**
- 检查图片路径格式
- 确认正则表达式匹配

**错误："无法读取图片文件"**
- 检查文件是否存在
- 确认文件访问权限
- 尝试不同的路径格式

**错误："图片上传失败"**
- 检查 Halo API 配置
- 确认网络连接
- 检查 API Token 权限

**错误："所有路径都无法访问图片文件"**
- 确认 assets 目录结构
- 检查文件名是否正确
- 尝试重新插入图片

### 8. 技术限制

**当前支持的图片格式：**
- PNG (.png)
- JPEG (.jpg, .jpeg)
- GIF (.gif)
- WebP (.webp)
- SVG (.svg)

**不支持的情况：**
- 外部图片链接（会被跳过）
- 非标准路径格式
- 损坏的图片文件
- 过大的图片文件（取决于 Halo 设置）

### 9. 获取帮助

如果以上步骤都无法解决问题，请：

1. **收集信息：**
   - 插件版本
   - Logseq 版本
   - Halo 版本
   - 错误日志
   - 图片文件信息

2. **提供详细描述：**
   - 具体的错误现象
   - 重现步骤
   - 预期结果 vs 实际结果

3. **检查更新：**
   - 确保使用最新版本的插件
   - 查看是否有已知问题和修复

## 调试检查清单

- [ ] 图片路径格式正确（`../assets/xxx.png`）
- [ ] 图片文件真实存在于 assets 目录
- [ ] Halo 站点配置正确
- [ ] API Token 有效且有权限
- [ ] 网络连接正常
- [ ] 插件日志级别设置为 DEBUG
- [ ] 浏览器控制台无错误信息
- [ ] 测试文章发布成功
- [ ] Halo 后台可以看到上传的附件

按照这个检查清单逐项排查，通常可以找到问题所在。